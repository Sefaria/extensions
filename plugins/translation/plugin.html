<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sefaria AI Translation</title>
  <style>
    :root {
      color-scheme: light;
      --ink: #0f172a;
      --muted: #475569;
      --line: #e2e8f0;
      --panel: #ffffff;
      --bg: #f8fafc;
      --accent: #1f3b57;
      --accent-2: #2563eb;
      --accent-soft: #eef2ff;
    }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 8px 28px rgba(15, 23, 42, 0.1);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .title {
      font-size: 18px;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: 0.01em;
    }
    .subtitle {
      color: var(--muted);
      font-size: 13px;
    }
    .ref-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--accent-soft);
      border: 1px solid #dbe3f9;
      color: var(--accent);
      font-weight: 600;
      width: fit-content;
    }
    .status {
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }
    .status.error {
      color: #b91c1c;
    }
    .translation {
      min-height: 120px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      line-height: 1.6;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.04);
      white-space: pre-wrap;
    }
    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--accent-2);
      background: linear-gradient(145deg, #2563eb, #1d4ed8);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      transition: opacity 140ms ease, transform 140ms ease, box-shadow 140ms ease;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.2);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.secondary {
      border: 1px solid #cbd5e1;
      background: #fff;
      color: var(--accent);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
    }
    button.secondary:not(:disabled):hover {
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
    }
    .thumb {
      font-size: 16px;
    }
  </style>
</head>
<body>
  <main class="card">
    <header>
      <div class="title">AI Translation</div>
      <div class="subtitle">Translate the current Sefaria reference with AI.</div>
    </header>
    <div id="refBadge" class="ref-pill" style="display:none;"></div>
    <div id="status" class="status">Waiting for a reference‚Ä¶</div>
    <section id="translation" class="translation">No translation yet.</section>
    <div class="actions">
      <button id="tryBtn" class="secondary" type="button" disabled>Try again</button>
      <button id="thumbBtn" type="button" disabled><span class="thumb">üëç</span> Looks good</button>
    </div>
  </main>

  <script>
    const statusEl = document.getElementById('status');
    const refBadgeEl = document.getElementById('refBadge');
    const translationEl = document.getElementById('translation');
    const tryBtn = document.getElementById('tryBtn');
    const thumbBtn = document.getElementById('thumbBtn');
    const textParams = new URLSearchParams({
      context: '0',
      stripItags: '1',
      fallbackOnDefaultVersion: '1'
    });

    const htmlStripper = document.createElement('div');

    let currentRef = '';
    let loading = false;
    let lastRequestedRef = '';

    function setStatus(text, type = '') {
      statusEl.textContent = text;
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }

    function setButtonsEnabled(enabled) {
      tryBtn.disabled = !enabled;
      thumbBtn.disabled = !enabled;
    }

    function updateRef(ref) {
      currentRef = (ref || '').trim();
      if (!currentRef) {
        refBadgeEl.style.display = 'none';
        translationEl.textContent = 'No translation yet.';
        setStatus('Waiting for a reference‚Ä¶');
        setButtonsEnabled(false);
        return;
      }
      if (currentRef === lastRequestedRef && loading) return;
      refBadgeEl.style.display = 'inline-flex';
      refBadgeEl.textContent = currentRef.replace(/_/g, ' ');
      fetchTranslation(currentRef);
    }

    function stripHtml(raw) {
      if (raw == null) return '';
      if (typeof raw !== 'string') return stripHtml(String(raw));
      htmlStripper.innerHTML = raw;
      const text = htmlStripper.textContent || htmlStripper.innerText || '';
      htmlStripper.textContent = '';
      return text.trim();
    }

    function flattenText(value) {
      if (!value) return '';
      if (Array.isArray(value)) return value.map(flattenText).filter(Boolean).join('\n').trim();
      if (typeof value === 'object') {
        if ('text' in value) return flattenText(value.text);
        if ('he' in value) return flattenText(value.he);
        if ('content' in value) return flattenText(value.content);
        return '';
      }
      return stripHtml(value);
    }

    async function fetchSourceText(ref) {
      const url = `https://www.sefaria.org/api/texts/${encodeURIComponent(ref)}?${textParams.toString()}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Sefaria API error (${response.status})`);
      const data = await response.json();
      if (data && data.error) throw new Error(data.error);
      const text = flattenText(data?.he);
      if (!text) throw new Error('No text available for translation.');
      return text;
    }

    async function fetchTranslation(ref) {
      if (!ref) return;
      if (loading && ref === lastRequestedRef) return;
      lastRequestedRef = ref;
      loading = true;
      setButtonsEnabled(false);
      setStatus('Fetching source text‚Ä¶');
      translationEl.textContent = 'Working on the translation‚Ä¶';

      try {
        const sourceText = await fetchSourceText(ref);
        setStatus('Translating‚Ä¶');

        const resp = await fetch('https://plugin-ai.sefaria.org/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: sourceText, source_language: 'hebrew' })
        });
        if (!resp.ok) throw new Error(`Server error (${resp.status})`);
        const data = await resp.json();
        const text = data?.translation || 'No translation returned.';
        translationEl.textContent = text;
        setStatus('Translation ready');
      } catch (err) {
        console.error(err);
        translationEl.textContent = 'Unable to fetch translation.';
        setStatus(err.message || 'Failed to translate.', 'error');
      } finally {
        loading = false;
        setButtonsEnabled(Boolean(currentRef) && !loading);
      }
    }

    tryBtn.addEventListener('click', () => {
      if (!currentRef || loading) return;
      fetchTranslation(currentRef);
    });

    thumbBtn.addEventListener('click', () => {
      if (!currentRef) return;
      setStatus('Thanks for the feedback!');
      window.parent.postMessage({ type: 'plugin:log', message: `Translation approved for ${currentRef}` }, '*');
    });

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || typeof data !== 'object') return;
      if (data.type === 'sref:update' || data.type === 'sref:response') {
        updateRef(data.sref || '');
      }
    });

    window.parent.postMessage({ type: 'plugin:ready' }, '*');
  </script>
</body>
</html>
