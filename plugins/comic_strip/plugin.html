<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Talmudic Comic Strip</title>
  <style>
    :root {
      color-scheme: light;
      --ink: #0f172a;
      --muted: #475569;
      --line: #e2e8f0;
      --panel-bg: #fff;
      --bg: #f6f7fb;
      --accent: #4c1d95;
      --accent-soft: #ede9fe;
      --accent-2: #2563eb;
      font-size: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, #f9f5ff, #eef2ff 60%, #f8fafc);
      min-height: 100vh;
      padding: 18px;
      color: var(--ink);
      display: flex;
      justify-content: center;
    }
    .card {
      width: 100%;
      max-width: 900px;
      background: var(--panel-bg);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .title {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: 0.01em;
    }
    .subtitle {
      color: var(--muted);
      font-size: 14px;
    }
    .ref-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      border: 1px solid rgba(76, 29, 149, 0.2);
      width: fit-content;
    }
    .status {
      font-size: 14px;
      color: var(--muted);
      min-height: 20px;
    }
    .status.error { color: #b91c1c; }
    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .field label {
      font-weight: 600;
      font-size: 14px;
      color: var(--ink);
    }
    textarea {
      width: 100%;
      min-height: 120px;
      border-radius: 14px;
      border: 1px solid var(--line);
      padding: 14px;
      font: inherit;
      line-height: 1.4;
      resize: vertical;
      background: #fff;
    }
    textarea:focus {
      outline: 3px solid rgba(37, 99, 235, 0.15);
      border-color: var(--accent-2);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cbd5f5;
      background: #fff;
      font: inherit;
      flex: 1;
      min-width: 160px;
    }
    button {
      padding: 12px 18px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #fff;
      font-weight: 700;
      letter-spacing: 0.01em;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(234, 88, 12, 0.28);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(234, 88, 12, 0.32);
    }
    .hint {
      font-size: 13px;
      color: var(--muted);
    }
    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .panel-card {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #fff;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 260px;
    }
    .panel-title {
      font-weight: 700;
      color: var(--accent);
      font-size: 14px;
    }
    .panel-preview {
      aspect-ratio: 4 / 3;
      border: 1px dashed #d4d4f7;
      border-radius: 12px;
      display: grid;
      place-items: center;
      overflow: hidden;
      background: #faf5ff;
    }
    .panel-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .panel-preview .placeholder {
      font-size: 12px;
      color: #a5a5c3;
      text-align: center;
      padding: 0 12px;
    }
    .panel-caption {
      font-size: 13px;
      color: var(--ink);
      background: #f8fafc;
      border-radius: 10px;
      padding: 8px 10px;
      min-height: 48px;
    }
  </style>
</head>
<body>
  <main class="card">
    <header>
      <div class="title">Talmudic Comic Strip</div>
      <div class="subtitle">Turn a sugya into a three-panel visual argument.</div>
    </header>
    <div id="refBadge" class="ref-pill" style="display:none;"></div>
    <div id="status" class="status">Share a passage or argument to start.</div>

    <div class="field">
      <label for="argumentInput">Argument Text</label>
      <textarea id="argumentInput" placeholder="Paste or edit the Talmudic exchange you want to visualize."></textarea>
    </div>

    <div class="controls">
      <select id="styleSelect" aria-label="Comic style">
        <option value="scholarly ink comic" selected>Scholarly ink comic</option>
        <option value="playful watercolor strip">Playful watercolor strip</option>
        <option value="retro newspaper comic">Retro newspaper comic</option>
        <option value="modern graphic novel panels">Modern graphic novel panels</option>
      </select>
      <button id="generateBtn" type="button" disabled>
        <span>Generate Comic Strip</span>
      </button>
    </div>

    <p class="hint">We automatically break the text into setup, challenge, and resolution beats. Edit the text before generating if needed.</p>

    <section class="panel-grid">
      <article class="panel-card" data-panel="0">
        <div class="panel-title">Panel 1 · Setup</div>
        <div class="panel-preview">
          <div class="placeholder">No image yet</div>
          <img alt="Panel 1 preview" />
        </div>
        <p class="panel-caption">Waiting for text…</p>
      </article>
      <article class="panel-card" data-panel="1">
        <div class="panel-title">Panel 2 · Challenge</div>
        <div class="panel-preview">
          <div class="placeholder">No image yet</div>
          <img alt="Panel 2 preview" />
        </div>
        <p class="panel-caption">Waiting for text…</p>
      </article>
      <article class="panel-card" data-panel="2">
        <div class="panel-title">Panel 3 · Resolution</div>
        <div class="panel-preview">
          <div class="placeholder">No image yet</div>
          <img alt="Panel 3 preview" />
        </div>
        <p class="panel-caption">Waiting for text…</p>
      </article>
    </section>
  </main>

  <script>
    const argumentInput = document.getElementById('argumentInput');
    const styleSelect = document.getElementById('styleSelect');
    const generateBtn = document.getElementById('generateBtn');
    const statusEl = document.getElementById('status');
    const refBadgeEl = document.getElementById('refBadge');
    const panelCards = Array.from(document.querySelectorAll('.panel-card'));

    const textParams = new URLSearchParams({
      context: '0',
      stripItags: '1',
      fallbackOnDefaultVersion: '1'
    });

    const panelLabels = ['Setup', 'Challenge', 'Resolution'];
    const htmlStripper = document.createElement('div');

    let currentRef = '';
    let loading = false;

    function setStatus(text, type = '') {
      statusEl.textContent = text;
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }

    function stripHtml(raw) {
      if (raw == null) return '';
      if (typeof raw !== 'string') return stripHtml(String(raw));
      htmlStripper.innerHTML = raw;
      const text = htmlStripper.textContent || htmlStripper.innerText || '';
      htmlStripper.textContent = '';
      return text.trim();
    }

    function flattenText(value) {
      if (!value) return '';
      if (Array.isArray(value)) return value.map(flattenText).filter(Boolean).join('\n').trim();
      if (typeof value === 'object') {
        if ('text' in value) return flattenText(value.text);
        if ('he' in value) return flattenText(value.he);
        if ('content' in value) return flattenText(value.content);
        return '';
      }
      return stripHtml(value);
    }

    async function fetchSourceText(ref) {
      const url = `https://www.sefaria.org/api/texts/${encodeURIComponent(ref)}?${textParams.toString()}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Sefaria API error (${response.status})`);
      const data = await response.json();
      if (data && data.error) throw new Error(data.error);
      const text = flattenText(data?.text) || flattenText(data?.he);
      if (!text) throw new Error('No text available for this reference.');
      return text;
    }

    function splitIntoBeats(text, beats = 3) {
      const cleaned = text.replace(/\s+/g, ' ').trim();
      if (!cleaned) return Array(beats).fill('');
      const words = cleaned.split(' ');
      const perChunk = Math.ceil(words.length / beats) || 1;
      const chunks = [];
      for (let i = 0; i < beats; i++) {
        const slice = words.slice(i * perChunk, (i + 1) * perChunk);
        chunks.push(slice.join(' ').trim());
      }
      return chunks;
    }

    function updatePanelCaptions(text) {
      const beats = splitIntoBeats(text);
      panelCards.forEach((card, index) => {
        const caption = card.querySelector('.panel-caption');
        caption.textContent = beats[index] || 'Add more detail to the argument text above.';
      });
      generateBtn.disabled = !text.trim() || loading;
    }

    async function hydrateFromRef(ref) {
      const normalizedRef = (ref || '').trim();
      currentRef = normalizedRef;
      if (!normalizedRef) {
        refBadgeEl.style.display = 'none';
        setStatus('Share a passage or argument to start.');
        return;
      }
      refBadgeEl.style.display = 'inline-flex';
      refBadgeEl.textContent = normalizedRef.replace(/_/g, ' ');
      setStatus('Fetching text from Sefaria…');
      try {
        const sourceText = await fetchSourceText(normalizedRef);
        argumentInput.value = sourceText;
        updatePanelCaptions(sourceText);
        setStatus('Loaded text from reference. Edit if needed, then generate.');
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'Unable to load text for this reference.', 'error');
      }
    }

    function buildPanelPayload(argumentText) {
      const beats = splitIntoBeats(argumentText);
      return beats.map((beat, index) => ({
        title: panelLabels[index],
        summary: beat,
        prompt: `${panelLabels[index]}: ${beat}`.trim()
      }));
    }

    function resetPanelsLoading() {
      panelCards.forEach((card) => {
        const placeholder = card.querySelector('.placeholder');
        const img = card.querySelector('img');
        placeholder.textContent = 'Rendering…';
        placeholder.style.display = 'block';
        img.style.display = 'none';
        img.removeAttribute('src');
      });
    }

    function applyPanelResults(panelResults = []) {
      panelCards.forEach((card, index) => {
        const placeholder = card.querySelector('.placeholder');
        const img = card.querySelector('img');
        const caption = card.querySelector('.panel-caption');
        const result = panelResults[index] || {};
        if (result.image_url || result.url || result.image) {
          img.src = result.image_url || result.url || result.image;
          img.style.display = 'block';
          placeholder.style.display = 'none';
        } else {
          placeholder.textContent = 'No image from server.';
          placeholder.style.display = 'block';
          img.style.display = 'none';
        }
        if (result.caption) {
          caption.textContent = result.caption;
        }
      });
    }

    async function generateComicStrip() {
      const argumentText = argumentInput.value.trim();
      if (!argumentText || loading) return;
      loading = true;
      generateBtn.disabled = true;
      setStatus('Drafting panel prompts…');
      resetPanelsLoading();

      const panels = buildPanelPayload(argumentText);

      try {
        const response = await fetch('https://plugin-ai.sefaria.org/api/generate-comic-strip', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reference: currentRef || null,
            argument: argumentText,
            style: styleSelect.value,
            panels
          })
        });

        if (!response.ok) throw new Error(`Server error (${response.status})`);
        const data = await response.json();
        if (!data) throw new Error('Empty response from server.');
        const panelResults = Array.isArray(data.panels) ? data.panels : [];
        applyPanelResults(panelResults);
        setStatus('Comic strip ready.');
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'Failed to generate comic strip.', 'error');
        panelCards.forEach((card) => {
          const placeholder = card.querySelector('.placeholder');
          placeholder.textContent = 'Unable to render.';
          card.querySelector('img').style.display = 'none';
        });
      } finally {
        loading = false;
        generateBtn.disabled = !argumentInput.value.trim();
      }
    }

    argumentInput.addEventListener('input', (event) => {
      updatePanelCaptions(event.target.value);
    });

    generateBtn.addEventListener('click', generateComicStrip);

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || typeof data !== 'object') return;
      if (data.type === 'sref:update' || data.type === 'sref:response') {
        hydrateFromRef(data.sref || '');
      }
    });

    window.parent.postMessage({ type: 'plugin:ready' }, '*');
  </script>
</body>
</html>
